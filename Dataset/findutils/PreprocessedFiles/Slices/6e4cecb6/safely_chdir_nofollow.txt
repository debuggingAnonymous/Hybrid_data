safely_chdir_nofollow 

{

  int extraflags, fd;

  extraflags = 0;



  switch (symlink_handling)

    {

    case SymlinkFollowOk:

      extraflags = 0;

      break;



    case SymlinkHandleDefault:

      if (following_links())

 extraflags = 0;

      else

 extraflags = 0400000;

      break;

    }



  (*__errno_location ()) = 0;

  fd = open(dest, 00|extraflags);

  if (fd < 0)

    {

      switch ((*__errno_location ()))

 {

 case 40:

   return SafeChdirFailSymlink;

 case 2:

   return SafeChdirFailNonexistent;

 default:

   return SafeChdirFailChdirFailed;

 }

    }



  (*__errno_location ()) = 0;

  if (0 == fchdir(fd))

    {

      close(fd);

      return SafeChdirOK;

    }

  else

    {

      int saved_errno = (*__errno_location ());

      close(fd);

      (*__errno_location ()) = saved_errno;



      switch ((*__errno_location ()))

 {

 case 20:

   return SafeChdirFailNotDir;



 case 13:

 case 9:

 case 4:

 case 5:

 default:

   return SafeChdirFailChdirFailed;

 }

    }

}

